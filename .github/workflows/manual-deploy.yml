name: Manual Deployment

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment Environment'
        required: true
        type: choice
        options:
          - development
          - staging
          - production
      service:
        description: 'Service to Deploy (or all)'
        required: true
        type: choice
        options:
          - all
          - student-service
          - feedback-service
          - admin-service
          - frontend

jobs:
  manual-deploy:
    name: Deploy ${{ github.event.inputs.service }} to ${{ github.event.inputs.environment }}
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ” Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: ğŸ—ï¸ Build and Push Images
        run: |
          SERVICE="${{ github.event.inputs.service }}"
          ENV="${{ github.event.inputs.environment }}"
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸš€ Manual Deployment Started"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Environment: $ENV"
          echo "Service: $SERVICE"
          echo ""
          
          if [ "$SERVICE" = "all" ]; then
            echo "Building all services..."
            docker build -t ${{ secrets.DOCKER_USERNAME }}/student-service:$ENV ./student-service
            docker build -t ${{ secrets.DOCKER_USERNAME }}/feedback-service:$ENV ./feedback-service
            docker build -t ${{ secrets.DOCKER_USERNAME }}/admin-service:$ENV ./admin-service
            docker build -t ${{ secrets.DOCKER_USERNAME }}/student-feedback-frontend:$ENV ./frontend
            
            docker push ${{ secrets.DOCKER_USERNAME }}/student-service:$ENV
            docker push ${{ secrets.DOCKER_USERNAME }}/feedback-service:$ENV
            docker push ${{ secrets.DOCKER_USERNAME }}/admin-service:$ENV
            docker push ${{ secrets.DOCKER_USERNAME }}/student-feedback-frontend:$ENV
          else
            echo "Building $SERVICE..."
            if [ "$SERVICE" = "frontend" ]; then
              docker build -t ${{ secrets.DOCKER_USERNAME }}/student-feedback-frontend:$ENV ./frontend
              docker push ${{ secrets.DOCKER_USERNAME }}/student-feedback-frontend:$ENV
            else
              docker build -t ${{ secrets.DOCKER_USERNAME }}/$SERVICE:$ENV ./$SERVICE
              docker push ${{ secrets.DOCKER_USERNAME }}/$SERVICE:$ENV
            fi
          fi
          
          echo ""
          echo "âœ… Deployment completed successfully!"

      - name: ğŸ“‹ Deployment Instructions
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“ Next Steps:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "To apply the deployment to Kubernetes:"
          echo ""
          if [ "${{ github.event.inputs.service }}" = "all" ]; then
            echo "kubectl set image deployment/student-service student-service=${{ secrets.DOCKER_USERNAME }}/student-service:${{ github.event.inputs.environment }} -n student-feedback"
            echo "kubectl set image deployment/feedback-service feedback-service=${{ secrets.DOCKER_USERNAME }}/feedback-service:${{ github.event.inputs.environment }} -n student-feedback"
            echo "kubectl set image deployment/admin-service admin-service=${{ secrets.DOCKER_USERNAME }}/admin-service:${{ github.event.inputs.environment }} -n student-feedback"
            echo "kubectl set image deployment/frontend frontend=${{ secrets.DOCKER_USERNAME }}/student-feedback-frontend:${{ github.event.inputs.environment }} -n student-feedback"
          else
            SERVICE_NAME="${{ github.event.inputs.service }}"
            if [ "$SERVICE_NAME" = "frontend" ]; then
              echo "kubectl set image deployment/frontend frontend=${{ secrets.DOCKER_USERNAME }}/student-feedback-frontend:${{ github.event.inputs.environment }} -n student-feedback"
            else
              echo "kubectl set image deployment/$SERVICE_NAME $SERVICE_NAME=${{ secrets.DOCKER_USERNAME }}/$SERVICE_NAME:${{ github.event.inputs.environment }} -n student-feedback"
            fi
          fi